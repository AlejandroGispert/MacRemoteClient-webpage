---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Verify Email - Mac Remote Controller">
	<div class="verify-container">
		<div class="verify-card">
			<h1>Email Verification</h1>
			<div id="verify-status" class="status-message">
				<p>Verifying your email...</p>
			</div>
		</div>
	</div>
</Layout>

<script>
	if (typeof window !== 'undefined') {
		import('../lib/api').then(({ verifyEmailToken }) => {
			// Get token from URL
			const urlParams = new URLSearchParams(window.location.search);
			const token = urlParams.get('token');

			const statusElement = document.getElementById('verify-status');

			if (!token) {
				if (statusElement) {
					statusElement.innerHTML = `
						<div class="error">
							<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<circle cx="12" cy="12" r="10"/>
								<path d="M12 8v4M12 16h.01"/>
							</svg>
							<h2>Invalid Verification Link</h2>
							<p>This verification link is invalid or missing a token.</p>
							<a href="/" class="button">Go to Homepage</a>
						</div>
					`;
				}
			} else {
				// Verify the token
				verifyEmailToken(token).then(async (result) => {
					if (result.success && statusElement) {
						// Track download after verification
						if (result.email) {
							try {
								const { trackDownload } = await import('../lib/api');
								await trackDownload(result.email);
							} catch (err) {
								console.error('Error tracking download:', err);
							}
						}

						// Download URL
						const downloadUrl = '/files/MacRCDesktop_v2.0.dmg';
						
						// Automatically trigger download
						const link = document.createElement('a');
						link.href = downloadUrl;
						link.download = 'MacRCDesktop_v2.0.dmg';
						link.target = '_blank';
						link.rel = 'noopener noreferrer';
						document.body.appendChild(link);
						link.click();
						document.body.removeChild(link);

						statusElement.innerHTML = `
							<div class="success">
								<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
									<polyline points="22 4 12 14.01 9 11.01"/>
								</svg>
								<h2>Email Verified Successfully!</h2>
								<p>Your email has been verified and your download has started automatically.</p>
								<p class="small-text">If the download didn't start, <a href="${downloadUrl}" download="MacRCDesktop_v2.0.dmg" class="download-link">click here to download</a></p>
								<a href="/" class="button">Go to Homepage</a>
							</div>
						`;
					} else if (statusElement) {
						statusElement.innerHTML = `
							<div class="error">
								<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<circle cx="12" cy="12" r="10"/>
									<path d="M12 8v4M12 16h.01"/>
								</svg>
								<h2>Verification Failed</h2>
								<p>${result.error || 'This verification link is invalid or has expired.'}</p>
								<a href="/#download" class="button">Request New Verification Email</a>
							</div>
						`;
					}
				}).catch((error) => {
					if (statusElement) {
						statusElement.innerHTML = `
							<div class="error">
								<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<circle cx="12" cy="12" r="10"/>
									<path d="M12 8v4M12 16h.01"/>
								</svg>
								<h2>Verification Error</h2>
								<p>An error occurred while verifying your email. Please try again.</p>
								<a href="/#download" class="button">Try Again</a>
							</div>
						`;
					}
				});
			}
		});
	}
</script>

<style>
	.verify-container {
		min-height: 70vh;
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 2rem;
	}

	.verify-card {
		background: rgba(255, 255, 255, 0.05);
		backdrop-filter: blur(10px);
		border: 1px solid rgba(255, 255, 255, 0.1);
		border-radius: 1rem;
		padding: 3rem;
		max-width: 500px;
		width: 100%;
		text-align: center;
	}

	.verify-card h1 {
		font-size: 2rem;
		font-weight: 700;
		color: white;
		margin-bottom: 2rem;
	}

	.status-message {
		margin-top: 2rem;
	}

	.status-message svg {
		margin-bottom: 1.5rem;
		color: currentColor;
	}

	.success {
		color: #10b981;
	}

	.success h2 {
		font-size: 1.5rem;
		font-weight: 600;
		margin-bottom: 1rem;
		color: white;
	}

	.success p {
		color: rgba(255, 255, 255, 0.75);
		margin-bottom: 1rem;
		line-height: 1.6;
	}

	.success .small-text {
		font-size: 0.875rem;
		color: rgba(255, 255, 255, 0.6);
		margin-top: 1rem;
	}

	.success .download-link {
		color: #667eea;
		text-decoration: underline;
		transition: color 0.2s;
	}

	.success .download-link:hover {
		color: #764ba2;
	}

	.error {
		color: #ef4444;
	}

	.error h2 {
		font-size: 1.5rem;
		font-weight: 600;
		margin-bottom: 1rem;
		color: white;
	}

	.error p {
		color: rgba(255, 255, 255, 0.75);
		margin-bottom: 2rem;
		line-height: 1.6;
	}

	.button {
		display: inline-block;
		padding: 0.75rem 1.5rem;
		background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		color: white;
		text-decoration: none;
		border-radius: 0.5rem;
		font-weight: 600;
		transition: all 0.2s;
	}

	.button:hover {
		transform: translateY(-2px);
		box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
	}

	@media (max-width: 520px) {
		.verify-card {
			padding: 2rem 1.5rem;
		}

		.verify-card h1 {
			font-size: 1.5rem;
		}
	}
</style>
